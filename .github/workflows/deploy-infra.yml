name: CI/CD Infrastructure Code Main

on:
  push:
    branches: [ main ]
    paths:
      - 'infra/**'
      - 'automation/**'
      - 'management/**'

jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout Code
        uses: actions/checkout@v4

      # PASO NUEVO: Copia los archivos del repo al servidor
      - name: Copy files via SCP
        uses: appleboy/scp-action@v0.1.7
        with:
          host: ${{ secrets.HOST }}
          username: ${{ secrets.USERNAME }}
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          source: "infra/,automation/,management/"
          target: "/home/ubuntu/"

      - name: Deploy Stacks via SSH
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.HOST }}
          username: ${{ secrets.USERNAME }}
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          script: |
            # --- 1. ESTRUCTURA Y PERMISOS ---
            mkdir -p ~/infra/letsencrypt ~/automation/n8n_data ~/automation/postgres_data ~/management/portainer_data ~/backups
            sudo chown -R 1000:1000 ~/automation/n8n_data
            touch ~/infra/letsencrypt/acme.json
            chmod 600 ~/infra/letsencrypt/acme.json

            # --- 2. GESTIÓN DE REDES ---
            sudo docker network create --driver overlay public_net || true

            # --- 3. BACKUP CON ROTACIÓN ---
            BACKUP_NAME="n8n_db_$(date +%F_%H-%M)"
            if [ "$(sudo docker ps -q -f name=n8n_postgres)" ]; then
                sudo docker exec $(sudo docker ps -q -f name=n8n_postgres) pg_dumpall -U n8n_user > ~/backups/$BACKUP_NAME.sql
                gzip ~/backups/$BACKUP_NAME.sql
            fi
            find ~/backups/ -name "*.gz" -mtime +7 -exec rm {} \;

            # --- 4. DESPLIEGUE (Ahora con archivos reales) ---
            # Usamos los archivos que acabamos de copiar vía SCP
            sudo docker stack deploy -c ~/infra/docker-compose.yml infra --prune
            sudo docker stack deploy -c ~/management/portainer-stack.yml portainer --prune
            sudo docker stack deploy -c ~/automation/n8n-stack.yml n8n --prune

            # --- 5. LIMPIEZA ---
            sudo docker image prune -a -f