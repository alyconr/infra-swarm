name: CI/CD Infrastructure Code Main

on:
  push:
    branches: [main]
    paths:
      - "infra/**"
      - "automation/**"
      - "management/**"

jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout Code
        uses: actions/checkout@v4

      - name: Copy files via SCP
        uses: appleboy/scp-action@v0.1.7
        with:
          host: ${{ secrets.HOST }}
          username: ${{ secrets.USERNAME }}
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          source: "infra/,automation/,management/"
          target: "/home/ubuntu/"

      - name: Deploy Stacks via SSH
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.HOST }}
          username: ${{ secrets.USERNAME }}
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          script: |
            # --- 1. ESTRUCTURA Y PERMISOS ---
            mkdir -p ~/n8n/n8n_data ~/n8n/postgres_data ~/management/portainer_data ~/backups
            sudo chown -R 1000:1000 ~/n8n/n8n_data
            touch ~/infra/letsencrypt/acme.json
            chmod 600 ~/infra/letsencrypt/acme.json

            # --- 2. GESTIÓN DE VARIABLES SENSIBLES (.env) ---
            # Usamos comillas simples para evitar que bash intente interpretar caracteres especiales en las contraseñas
            printf "POSTGRES_USER='%s'\n" "${{ secrets.POSTGRES_USER }}" > ~/automation/.env
            printf "POSTGRES_PASSWORD='%s'\n" "${{ secrets.POSTGRES_PASSWORD }}" >> ~/automation/.env
            printf "POSTGRES_DB='%s'\n" "${{ secrets.POSTGRES_DB }}" >> ~/automation/.env
            chmod 600 ~/automation/.env

            # --- 3. GESTIÓN DE REDES ---
            sudo docker network create --driver overlay public_net || true

            # --- 4. BACKUP PREVENTIVO ---
            # Escapamos el signo $ de date para que bash lo ejecute en el servidor, no GitHub
            BACKUP_NAME="n8n_db_$(date +%F_%H-%M)"

            # Buscamos el ID del contenedor de forma más robusta
            POSTGRES_CONTAINER=$(sudo docker ps -q -f name=n8n_postgres)

            if [ ! -z "$POSTGRES_CONTAINER" ]; then
                echo "Realizando backup de la base de datos..."
                sudo docker exec $POSTGRES_CONTAINER pg_dumpall -U "${{ secrets.POSTGRES_USER }}" > ~/backups/$BACKUP_NAME.sql
                gzip ~/backups/$BACKUP_NAME.sql
            fi
            find ~/backups/ -name "*.gz" -mtime +7 -exec rm {} \;

            # --- 5. DESPLIEGUE ---
            sudo docker stack deploy -c ~/infra/docker-compose.yml infra --prune
            sudo docker stack deploy -c ~/management/portainer-stack.yml portainer --prune

            # Entramos a la carpeta para que Swarm detecte el archivo .env automáticamente
            cd ~/automation && sudo docker stack deploy -c n8n-stack.yml n8n --prune

            # --- 6. LIMPIEZA ---
            sudo docker image prune -a -f
